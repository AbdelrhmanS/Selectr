/*! Selectr.js | Copyright (c) 2016 Karl Saunders (http://mobiuswebdesign.co.uk) */
!function(a,b){var c="Selectr";"function"==typeof define&&define.amd?define([],b(c)):"object"==typeof exports?module.exports=b(c):a[c]=b(c)}(this,function(a){"use strict";function h(a,c){if(null===a)throw new Error("Selectr requires an element to work.");var d={minChars:1,width:"auto",emptyOption:!0,enableSearch:!0,selectedIndex:null,selectedValue:null,selectedIndexes:[],selectedValues:[],containerClass:""};this.elem=a,this.elemRect=this.elem.getBoundingClientRect(),this.selectedVal=null,this.selectedVals=[],this.ajaxOpts=!1,this.tags=[],this.opts=[],this.values=[],this.list=[],this.lastLen=0,this.disabled=!1,this.opened=!1,this.options=b(d,c),this.hasTemplate=this.options.hasOwnProperty("render")&&"function"==typeof this.options.render,this.initialise()}var b=function(a,b){var c;for(c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a},c=function(a,b){var c,d=document.createElement(a);if(b&&"object"==typeof b)for(c in b)if(c in d)"innerHTML"===c?d.innerHTML=b[c]:d[c]=b[c];else if("class"===c)for(var e=b[c].split(" "),f=e.length-1;f>=0;f--)e[f].length&&d.classList.add(e[f]);else d.setAttribute(c,b[c]);return d},d=function(a,b,c){if("[object Object]"===Object.prototype.toString.call(a)){var d;for(d in a)Object.prototype.hasOwnProperty.call(a,d)&&b.call(c,d,a[d],a)}else for(var e=0,f=a.length;e<f;e++)b.call(c,e,a[e],a)},e=function(a,b,c){var d;return function(){var e=this,f=arguments,g=function(){d=null,c||a.apply(e,f)},h=c&&!d;clearTimeout(d),d=setTimeout(g,b),h&&a.apply(e,f)}},f=function(a,b){a.classList.add(b)},g=function(a,b){a.classList.remove(b)};return h.prototype={initialise:function(){if(!this.initialised){var a=this;this.on=function(b,c){this.elem.addEventListener(b,function(b){c.call(a,b,this)})},a.options.ajax&&"object"==typeof a.options.ajax&&a.setAjaxUrl(),this.setSelections(),this.build(this.inputType),this.initialised=!0,setTimeout(function(){a.emit("selectr.init")},100)}},setSelections:function(){var a=this;"OPTGROUP"===this.elem.options[0].parentNode.nodeName&&(this.hasOptGroups=!0),this.elem.multiple?(this.options.emptyOption=!1,(this.options.selectedIndexes.length||this.options.selectedValues.length)&&d(this.elem.options,function(b,c){c.selected=!1,(a.options.selectedIndexes.indexOf(b)>-1||a.options.selectedValues.indexOf(c.value)>-1)&&(c.selected=!0)})):(this.options.emptyOption&&(this.emptyOpt=c("option",{value:"",selected:!0}),this.hasOptGroups?this.elem.insertBefore(this.emptyOpt,this.elem.options[0].parentNode):this.elem.insertBefore(this.emptyOpt,this.elem.options[0])),null!==this.options.selectedIndex?(this.options.emptyOption&&this.options.selectedIndex++,this.elem.value=this.elem.options[this.options.selectedIndex].value):null!==this.options.selectedValue&&(this.elem.value=this.options.selectedValue))},setAjaxUrl:function(){this.ajaxOpts=!0;var a=this,b=a.options.ajax;a.ajax_url=b.url,b.queryParam&&(a.ajax_url+="?",b.params&&d(b.params,function(b,c){a.ajax_url+=b+"="+c+"&"}),a.ajax_url+=b.queryParam+"="),"function"!=typeof a.options.ajax.formatSelected&&(a.options.ajax.formatSelected=function(a){return a.text})},build:function(){var a=this;this.optsFrag=document.createDocumentFragment(),f(this.elem,"hidden-input"),this.container=c("div",{id:"selectr-"+a.elem.id,class:"selectr-container "+this.options.containerClass}),this.selected=c("div",{class:"selectr-selected"}),this.spn=c(this.elem.multiple?"ul":"span",{class:"selectr-text"}),this.optsContainer=c("div",{class:"selectr-options-container"}),this.optsOptions=c("ul",{class:"selectr-options"}),this.elem.multiple&&(f(this.spn,"selectr-tags"),f(this.container,"multiple")),this.options.enableSearch&&(this.input=c("input",{class:"selectr-input"}),this.clear=c("button",{class:"selectr-clear",type:"button"}),this.inputContainer=c("div",{class:"selectr-input-container"})),this.hasOptGroups?(f(this.optsOptions,"optgroups"),d(this.elem.children,function(b,e){if("OPTGROUP"===e.nodeName){let b=c("li",{class:"selectr-optgroup",innerHTML:e.label});a.optsFrag.appendChild(b),d(e.children,function(b,c){a.buildOption(b,c)})}})):d(this.elem.options,function(b,c){a.buildOption(b,c)}),this.optsOptions.appendChild(this.optsFrag),this.selected.appendChild(this.spn),this.container.appendChild(this.selected),this.options.enableSearch&&(this.inputContainer.appendChild(this.input),this.inputContainer.appendChild(this.clear),this.optsContainer.appendChild(this.inputContainer)),this.optsContainer.appendChild(this.optsOptions),this.container.appendChild(this.optsContainer);var b=this.options.placeholder||this.elem.getAttribute("placeholder")||"Choose...";this.selected.appendChild(c("div",{class:"selectr-placeholder",innerHTML:b})),(!this.elem.multiple&&this.elem.value.length||this.elem.multiple&&this.spn.children.length)&&(f(this.container,"has-selected"),!this.elem.multiple&&this.emptyOpt&&(this.emptyOpt.selected=!1)),this.elem.parentNode.insertBefore(this.container,this.elem),this.container.appendChild(this.elem),this.setDimensions(),this.attachEventListeners()},buildOption:function(a,b){if(b!==this.emptyOpt&&"OPTION"===b.nodeName){var d=this.hasTemplate?this.options.render(b):b.textContent.trim(),e=c("li",{class:"selectr-option",innerHTML:d});b.hasAttribute("selected")&&(b.selected=!0),this.optsFrag.appendChild(e),b.selected&&(f(e,"selected"),this.elem.multiple?this.createTag(b):(this.spn.innerHTML=d,this.selectedIndex=a),this.selectedVals.push(b.value)),(this.options.emptyOption&&1===a||!this.options.emptyOption&&0===a)&&(f(e,"active"),this.activeIdx=0),this.opts.push(b),this.values.push(b.value),this.list.push(e)}},attachEventListeners:function(){var a=this;a.selected.addEventListener("mousedown",function(a){a.preventDefault()}),a.optsOptions.addEventListener("mousedown",function(a){a.preventDefault()}),a.selected.addEventListener("click",a.toggleOptions.bind(a)),a.optsOptions.addEventListener("click",function(b){a.selectOption(b)}),a.elem.multiple&&a.spn.addEventListener("click",a.removeTags.bind(a)),a.options.enableSearch&&(a.input.addEventListener("keyup",a.search.bind(a)),a.clear.addEventListener("click",a.clearOptions.bind(a))),document.addEventListener("click",a.dismiss.bind(a)),a.resize=e(function(){a.setDimensions()},100),window.addEventListener("resize",a.resize),document.addEventListener("keydown",a.navigate.bind(a))},navigate:function(a){a=a||window.event;var b=this,c=a.keyCode;if(b.opened&&(13===c||38===c||40===c)){switch(c){case 13:return void b.selectOption(a);case 38:b.activeIdx>0&&b.activeIdx--;break;case 40:b.activeIdx<b.list.length-1&&b.activeIdx++}d(b.list,function(a,c){a===b.activeIdx?f(c,"active"):g(c,"active")})}},search:function(a){var b=this,c=b.input.value,e=c.length;if(!(e<this.options.minChars&&e>=this.lastLen)){if(this.ajaxOpts)return void this.ajaxSearch();c.length>0?f(this.inputContainer,"active"):g(this.inputContainer,"active"),d(b._this.list,function(a,d){let e=b.list[a],h=d.toLowerCase(),i=c.toLowerCase();if(h.includes(i)){if(b.hasTemplate)f(e,"match");else{let a=new RegExp(i,"i").exec(d);e.innerHTML=e.textContent.replace(a[0],"<span>"+a[0]+"</span>")}g(e,"excluded")}else f(e,"excluded"),g(e,"match")}),this.lastLen=this.input.value.length}},ajaxSearch:function(){function e(b){var c="",e='<li class="selectr-options" data-value="{value}" data-text="{text}">{template}</li>';return d(b,function(b,d){let f=a.formatResults(d)||text;c+=e.replace("{value}",d.value).replace("{text}",d.text||"").replace("{template}",f)}),c}f(this.inputContainer,"loading");var a=this.options.ajax,b=this,c=new XMLHttpRequest;c.onload=function(){if(4===c.readyState&&200===c.status){var d=JSON.parse(c.responseText),f=a.parseResults(d)||d,h=e(f);b.optsOptions.innerHTML=h,g(b.inputContainer,"loading"),b.remoteItems=f}},c.open("GET",b.ajax_url+b.input.value,!0),c.send()},selectOption:function(a){a=a||window.event;var b=this,c=a.target;if("keydown"===a.type&&(c=b.list[b.activeIdx]),"LI"===c.nodeName){if(b.ajaxOpts)return void b.selectRemoteOption(c);var e=b.list.indexOf(c),h=b.opts[e],i=!1;if(b.elem.multiple){if(c.classList.contains("selected")){var j;d(b.tags,function(a,b){b.getAttribute("data-value")===h.value&&(j=b)}),j&&b.removeTag(j)}else b.selectedVals.push(h.value),b.createTag(h),h.selected=!0,f(c,"selected"),b.emit("selectr.select"),b.input.value="";b.spn.children.length&&(i=!0)}else if(b.selectedIndex===e)b.spn.innerHTML="",h.selected=!1,g(c,"selected"),b.selectedVal=null,b.selectedIndex=null,b.emit("selectr.deselect");else{let a=b.optsOptions.getElementsByClassName("selected")[0];a&&g(a,"selected"),b.spn.innerHTML=b.hasTemplate?b.options.render(h):h.textContent,h.selected=!0,f(c,"selected"),b.selectedVal=h.value,b.selectedIndex=e,b.emit("selectr.select"),i=!0}i?f(b.container,"has-selected"):g(b.container,"has-selected"),b.reset(),b.elem.multiple||b.close(),b.emit("selectr.change")}},selectRemoteOption:function(a){var b=a.getAttribute("data-value"),c=!1;d(this.remoteItems,function(a,d){d.value==b&&(c=d)}),this.elem.multiple?(this.createTag(a,!0),this.selectedVals.push(b)):(this.spn.innerHTML=c?this.options.ajax.formatSelected(c):a.getAttribute("data-text")||a.textContent,this.selectedVal=b),this.elem.multiple&&this.elem.value.length>0?this.elem.value+=","+b:this.elem.value=b,this.elem.value?f(this.container,"has-selected"):g(this.container,"has-selected"),this.emit("selectr.select"),this.emit("selectr.change"),this.close()},createTag:function(a,b){var h,e=document.createDocumentFragment();h=b?a.getAttribute("data-text")||a.textContent:this.hasTemplate?this.options.render(a):a.textContent;let i=c("li",{class:"selectr-tag",innerHTML:h}),j=c("button",{class:"selectr-tag-remove",type:"button"});i.appendChild(j),e.appendChild(i),this.spn.appendChild(e),this.tags.push(i),this.spn.children.length?f(this.container,"has-selected"):g(this.container,"has-selected"),b?i.setAttribute("data-value",a.getAttribute("data-value")):i.setAttribute("data-value",a.value)},removeTags:function(a){if(!this.disabled){a=a||window.event;var b=a.target,c=b.nodeName;if("BUTTON"!=c)return!1;a.preventDefault(),a.stopPropagation(),this.removeTag(b.parentNode)}},removeTag:function(a,b){var d,c=a.getAttribute("data-value");if(this.ajaxOpts){d=this.selectedVals.indexOf(c);var f=this.elem.value.split(","),h=f.indexOf(c);f.splice(h,1),this.elem.value=f.join(",")}else{b=b||this.values.indexOf(c);var e=this.opts[b];d=this.selectedVals.indexOf(e.value),e.selected=!1,g(this.list[b],"selected")}this.selectedVals.splice(d,1),this.tags.splice(this.tags.indexOf(a),1),this.spn.removeChild(a),this.tags.length||g(this.container,"has-selected"),this.emit("selectr.deselect")},toggleOptions:function(){var b=this.container.classList.contains("open");return!this.disabled&&void(b?this.close():this.open())},clearOptions:function(){this.options.enableSearch&&(this.input.value=null,g(this.inputContainer,"active")),this.reset()},reset:function(){var a=this;d(this.list,function(b,c){let d=a.opts[b];c.innerHTML=a.hasTemplate?a.options.render(d):d.textContent,g(c,"match"),g(c,"excluded")})},open:function(){var a=this,b=this.elemRect.top+this.elemRect.height+230,c=window.innerHeight;b>c?f(this.container,"inverted"):g(this.container,"inverted"),f(this.container,"open"),this.options.enableSearch&&setTimeout(function(){a.input.focus()},10),this.opened=!0,this.emit("selectr.open")},close:function(){this.options.enableSearch&&this.input.blur(),g(this.container,"open");var a=document.getElementsByClassName("selectr-container");d(a,function(a,b){g(b,"open")}),this.opened=!1,this.emit("selectr.close")},dismiss:function(a){var b=a.target;!this.container.contains(b)&&this.opened&&this.close()},setValue:function(a){var b=this,c=[].slice.call(b.values).indexOf(a);if(c<0)return!1;if(b.elem.multiple)b.selectedVals.indexOf(a)<0&&b.createTag(b.opts[c]);else{b.spn.innerHTML=b.hasTemplate?b.options.render(b.opts[c]):b.opts[c].textContent;let a=b.optsOptions.getElementsByClassName("selected")[0];a&&g(a,"selected")}b.selectedVals.push(a),f(b.list[c],"selected"),f(b.container,"has-selected"),b.opts[c].selected=!0,b.emit("selectr.select")},getValue:function(){return this.elem.multiple?this.selectedVals:this.selectedVal},removeValue:function(a){if(this.tags.length){var b=this,c=[].slice.call(this.values).indexOf(a);if(!(c<0)){var e=this.list[c],f=this.opts[c];if(this.elem.multiple){var h;d(this.tags,function(b,c){c.getAttribute("data-value")===a&&(h=c)}),h&&b.removeTag(h)}else this.spn.innerHTML=this.hasTemplate?this.options.render(f):f.textContent,null!==this.elem.selectedIndex&&g(this.list[this.elem.selectedIndex],"selected");f.selected=!1,g(e,"selected"),this.emit("selectr.select")}}},setDimensions:function(){var a=this.options.width||this.elemRect.width;if("auto"==this.options.width&&(a="100%"),this.container.style.cssText+="width: "+a+"; ",this.opened){this.elemRect=this.elem.getBoundingClientRect();var b=this.elemRect.top+this.elemRect.height+230,c=window.innerHeight;b>c?f(this.container,"inverted"):g(this.container,"inverted")}},emit:function(a){this.elem.dispatchEvent(new Event(a))},enable:function(){this.disabled=!1,g(this.container,"disabled")},disable:function(){this.disabled=!0,f(this.container,"disabled")},destroy:function(){if(this.initialised){var a=this,b=a.container.parentNode;b.insertBefore(a.elem,a.container),b.removeChild(a.container),g(a.elem,"hidden-input"),!a.elem.multiple&&a.options.emptyOption&&a.elem.removeChild(a.elem.options[0]),a.container=null,a.selected=null,a.spn=null,a.optsContainer=null,a.optsOptions=null,a.input=null,a.clear=null,a.inputContainer=null,window.removeEventListener("resize",a.resize),document.removeEventListener("click",a.dismiss.bind(a)),document.removeEventListener("keydown",a.navigate.bind(a)),a.initialised=!1}}},h});